CREATE TABLE "menu" (
  "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "menu" varchar(30),
  "ordem" int4 DEFAULT 0,
  "icone" varchar(50),
  PRIMARY KEY ("id")
);
CREATE INDEX "idx_menu_id" ON "menu" (
  "id"
);

CREATE TABLE "menu_opcoes" (
  "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "id_menu" int4,
  "path_url" varchar(60) NOT NULL,
  "submenu" int4,
  "titulo" varchar(50),
  "ativo" bool DEFAULT False,
  "visivel_menu" bool DEFAULT False,
  "slug_permissao" varchar(50),
  PRIMARY KEY ("id")
);
CREATE UNIQUE INDEX "idx_menu_opcoes_id" ON "menu_opcoes" (
  "id"
);

CREATE TABLE "menu_opcoes_botoes" (
  "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "id_permissoes" int4 NOT NULL,
  "id_menu_opcoes" int4 NOT NULL,
  PRIMARY KEY ("id")
);
CREATE INDEX "idx_menu_opcoes_botoes_id_permissoes" ON "menu_opcoes_botoes" (
  "id_permissoes"
);
CREATE INDEX "idx_menu_opcoes_botoes_id_menu_opcoes" ON "menu_opcoes_botoes" (
  "id_menu_opcoes"
);
CREATE INDEX "idx_menu_opcoes_botoes_id" ON "menu_opcoes_botoes" (
  "id"
);

CREATE TABLE "modulo" (
  "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "nome" varchar(30),
  PRIMARY KEY ("id")
);
CREATE UNIQUE INDEX "idx_modulo_id" ON "modulo" (
  "id"
);

CREATE TABLE "modulo_menu_opcoes" (
  "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "id_modulo" int4 NOT NULL,
  "id_menu_opcoes" int4 NOT NULL,
  PRIMARY KEY ("id")
);
CREATE INDEX "idx_modulo_menu_opcoes_id_modulo" ON "modulo_menu_opcoes" (
  "id_modulo"
);
CREATE INDEX "idx_modulo_menu_opcoes_id_menu_opcoes" ON "modulo_menu_opcoes" (
  "id_menu_opcoes"
);

CREATE TABLE "perfil" (
  "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "nome" varchar(20) NOT NULL,
  PRIMARY KEY ("id")
);
CREATE INDEX "idx_perfil_id" ON "perfil" (
  "id"
);

CREATE TABLE "perfil_usuario" (
  "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "id_modulo_menu_opc" int4 NOT NULL,
  "id_perfil" int4 NOT NULL,
  PRIMARY KEY ("id")
);
CREATE INDEX "idx_perfil_usuario_id" ON "perfil_usuario" (
  "id"
);

CREATE TABLE "perfil_usuario_botoes" (
  "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "id_permissoes" int4 NOT NULL,
  "id_perfil_usuario" int4,
  PRIMARY KEY ("id")
);
CREATE UNIQUE INDEX "idx_perfil_usuario_botoes_id" ON "perfil_usuario_botoes" (
  "id"
);
CREATE INDEX "idx_perfil_usuario_botoes_id_permissoes" ON "perfil_usuario_botoes" (
  "id_permissoes"
);
CREATE INDEX "idx_perfil_usuario_botoes_id_perfil_usuario" ON "perfil_usuario_botoes" (
  "id_perfil_usuario"
);

CREATE TABLE "permissoes" (
  "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "nome" varchar(30) NOT NULL,
  "type_campo" varchar(10) NOT NULL,
  PRIMARY KEY ("id")
);
CREATE INDEX "idx_permissoes_id" ON "permissoes" (
  "id"
);

DROP INDEX "idx_menu_id";
CREATE INDEX "idx_menu_id" ON "menu" (
  "id"
);
DROP INDEX "idx_menu_opcoes_id";
CREATE UNIQUE INDEX "idx_menu_opcoes_id" ON "menu_opcoes" (
  "id"
);
DROP INDEX "idx_menu_opcoes_botoes_id_permissoes";
DROP INDEX "idx_menu_opcoes_botoes_id_menu_opcoes";
DROP INDEX "idx_menu_opcoes_botoes_id";
ALTER TABLE "menu_opcoes_botoes" ADD CONSTRAINT "fk_menu_opcoes_botoes_permissoes" FOREIGN KEY ("id_permissoes") REFERENCES "permissoes" ("id");
ALTER TABLE "menu_opcoes_botoes" ADD CONSTRAINT "fk_menu_opcoes_botoes_menu_opcoes" FOREIGN KEY ("id_menu_opcoes") REFERENCES "menu_opcoes" ("id");
CREATE INDEX "idx_menu_opcoes_botoes_id_permissoes" ON "menu_opcoes_botoes" (
  "id_permissoes"
);
CREATE INDEX "idx_menu_opcoes_botoes_id_menu_opcoes" ON "menu_opcoes_botoes" (
  "id_menu_opcoes"
);
CREATE INDEX "idx_menu_opcoes_botoes_id" ON "menu_opcoes_botoes" (
  "id"
);
DROP INDEX "idx_modulo_id";
CREATE UNIQUE INDEX "idx_modulo_id" ON "modulo" (
  "id"
);
DROP INDEX "idx_modulo_menu_opcoes_id_modulo";
DROP INDEX "idx_modulo_menu_opcoes_id_menu_opcoes";
ALTER TABLE "modulo_menu_opcoes" ADD CONSTRAINT "fk_modulo_menu_opcoes_modulo" FOREIGN KEY ("id_modulo") REFERENCES "modulo" ("id");
ALTER TABLE "modulo_menu_opcoes" ADD CONSTRAINT "fk_modulo_menu_opcoes_menu_opcoes" FOREIGN KEY ("id_menu_opcoes") REFERENCES "menu_opcoes" ("id");
CREATE INDEX "idx_modulo_menu_opcoes_id_modulo" ON "modulo_menu_opcoes" (
  "id_modulo"
);
CREATE INDEX "idx_modulo_menu_opcoes_id_menu_opcoes" ON "modulo_menu_opcoes" (
  "id_menu_opcoes"
);
DROP INDEX "idx_perfil_id";
CREATE INDEX "idx_perfil_id" ON "perfil" (
  "id"
);
DROP INDEX "idx_perfil_usuario_id";
ALTER TABLE "perfil_usuario" ADD CONSTRAINT "fk_perfil_usuario_perfil" FOREIGN KEY ("id_perfil") REFERENCES "perfil" ("id");
ALTER TABLE "perfil_usuario" ADD CONSTRAINT "fk_perfil_usuario_modulo_menu_opcoes" FOREIGN KEY ("id_modulo_menu_opc") REFERENCES "modulo_menu_opcoes" ("id");
CREATE INDEX "idx_perfil_usuario_id" ON "perfil_usuario" (
  "id"
);
DROP INDEX "idx_perfil_usuario_botoes_id";
DROP INDEX "idx_perfil_usuario_botoes_id_permissoes";
DROP INDEX "idx_perfil_usuario_botoes_id_perfil_usuario";
ALTER TABLE "perfil_usuario_botoes" ADD CONSTRAINT "fk_perfil_usuario_botoes_id_permissoes" FOREIGN KEY ("id_permissoes") REFERENCES "permissoes" ("id");
ALTER TABLE "perfil_usuario_botoes" ADD CONSTRAINT "fk_perfil_usuario_botoes_id_perfil_usuario" FOREIGN KEY ("id_perfil_usuario") REFERENCES "perfil_usuario" ("id");
CREATE UNIQUE INDEX "idx_perfil_usuario_botoes_id" ON "perfil_usuario_botoes" (
  "id"
);
CREATE INDEX "idx_perfil_usuario_botoes_id_permissoes" ON "perfil_usuario_botoes" (
  "id_permissoes"
);
CREATE INDEX "idx_perfil_usuario_botoes_id_perfil_usuario" ON "perfil_usuario_botoes" (
  "id_perfil_usuario"
);
DROP INDEX "idx_permissoes_id";
CREATE INDEX "idx_permissoes_id" ON "permissoes" (
  "id"
);

CREATE OR REPLACE VIEW c_perfil_usuario AS 
	select pub.id, mo.titulo AS Menu, (upper(COALESCE(mo.slug_permissao || '_' || p.nome, ''))) AS permissao, pu.id_perfil as IdPerfil  
	from perfil_usuario AS pu 
	inner join modulo_menu_opcoes AS mmo on pu.Id_Modulo_Menu_OPC = mmo.id
	inner join menu_opcoes AS mo on mo.id = mmo.id_menu_opcoes  
	inner join perfil_usuario_botoes AS pub on pub.id_perfil_usuario = pu.id 
	inner join permissoes AS p on p.id = pub.id_permissoes where mo.ativo = true;

-- inserts
INSERT INTO menu (id, menu, ordem, icone) VALUES (1, 'Cadastros', 1, 'pe-7s-plus');
INSERT INTO menu (id, menu, ordem, Icone) VALUES (6, 'Configurações', 6, 'pe-7s-config');

INSERT INTO menu_opcoes (id, id_menu, path_url, submenu, titulo, ativo, visivel_menu, slug_permissao) VALUES (3, 6, 'menuopcoes', 1, 'Menu de Opções', True, True, 'MENUOPCOES');
INSERT INTO menu_opcoes (id, id_menu, path_url, submenu, titulo, ativo, visivel_menu, slug_permissao) VALUES (13, 1, 'usuarios', 1, 'Usuários', True, True, 'CADUSUARIOS');
INSERT INTO menu_opcoes (id, id_menu, path_url, submenu, titulo, ativo, visivel_menu, slug_permissao) VALUES (14, 1, 'usuarios-perfil', 1, 'Usuários-Perfil', True, True, 'CADUSUPERFIL');

INSERT INTO permissoes (id, nome, type_campo) VALUES (1, 'Adicionar', 'butto');
INSERT INTO permissoes (id, nome, type_campo) VALUES (2, 'Editar', 'butto');
INSERT INTO permissoes (id, nome, type_campo) VALUES (3, 'Excluir', 'butto');

INSERT INTO menu_opcoes_botoes (id, id_permissoes, id_menu_opcoes) VALUES (39, 3, 13);
INSERT INTO menu_opcoes_botoes (id, id_permissoes, id_menu_opcoes) VALUES (40, 3, 14);
INSERT INTO menu_opcoes_botoes (id, id_permissoes, id_menu_opcoes) VALUES (41, 1, 14);
INSERT INTO menu_opcoes_botoes (id, id_permissoes, id_menu_opcoes) VALUES (42, 2, 14);
INSERT INTO menu_opcoes_botoes (id, id_permissoes, id_menu_opcoes) VALUES (43, 1, 13);
INSERT INTO menu_opcoes_botoes (id, id_permissoes, id_menu_opcoes) VALUES (44, 2, 13);


INSERT INTO modulo (id, nome) VALUES (1, 'Varejo');
INSERT INTO modulo (id, nome) VALUES (2, 'Supermercado');
INSERT INTO modulo (id, nome) VALUES (3, 'Sapataria');
INSERT INTO modulo (id, nome) VALUES (4, 'Farmácia');
INSERT INTO modulo (id, nome) VALUES (5, 'Autopeças');

INSERT INTO modulo_menu_opcoes (id, id_modulo, id_menu_opcoes) VALUES (5, 1, 3);	
INSERT INTO modulo_menu_opcoes (id, id_modulo, id_menu_opcoes) VALUES (16, 1, 13);
INSERT INTO modulo_menu_opcoes (id, id_modulo, id_menu_opcoes) VALUES (17, 1, 14);

INSERT INTO perfil (id, nome) VALUES (1, 'Administrativo');

INSERT INTO perfil_usuario (id, id_modulo_menu_opc, id_perfil) VALUES (14, 5, 1);	
INSERT INTO perfil_usuario (id, id_modulo_menu_opc, id_perfil) VALUES (16, 17, 1);	
INSERT INTO perfil_usuario (id, id_modulo_menu_opc, id_perfil) VALUES (26, 16, 1);

INSERT INTO perfil_usuario_botoes (id, id_permissoes, id_perfil_usuario) VALUES (19, 1, 14);
INSERT INTO perfil_usuario_botoes (id, id_permissoes, id_perfil_usuario) VALUES (20, 2, 14);
INSERT INTO perfil_usuario_botoes (id, id_permissoes, id_perfil_usuario) VALUES (21, 3, 14);
INSERT INTO perfil_usuario_botoes (id, id_permissoes, id_perfil_usuario) VALUES (60, 1, 16);
INSERT INTO perfil_usuario_botoes (id, id_permissoes, id_perfil_usuario) VALUES (61, 2, 16);
INSERT INTO perfil_usuario_botoes (id, id_permissoes, id_perfil_usuario) VALUES (64, 3, 16);
INSERT INTO perfil_usuario_botoes (id, id_permissoes, id_perfil_usuario) VALUES (66, 3, 26);
INSERT INTO perfil_usuario_botoes (id, id_permissoes, id_perfil_usuario) VALUES (67, 1, 26);
INSERT INTO perfil_usuario_botoes (id, id_permissoes, id_perfil_usuario) VALUES (68, 2, 26);


SELECT setval(pg_get_serial_sequence('menu', 'id'),(select max(id) from menu));
SELECT setval(pg_get_serial_sequence('menu_opcoes', 'id'),(select max(id) from menu_opcoes));
SELECT setval(pg_get_serial_sequence('menu_opcoes_botoes', 'id'),(select max(id) from menu_opcoes_botoes));
SELECT setval(pg_get_serial_sequence('modulo', 'id'),(select max(id) from modulo));
SELECT setval(pg_get_serial_sequence('modulo_menu_opcoes', 'id'),(select max(id) from modulo_menu_opcoes));
SELECT setval(pg_get_serial_sequence('perfil', 'id'),(select max(id) from perfil));
SELECT setval(pg_get_serial_sequence('perfil_usuario', 'id'),(select max(id) from perfil_usuario));
SELECT setval(pg_get_serial_sequence('perfil_usuario_botoes', 'id'),(select max(id) from perfil_usuario_botoes));
SELECT setval(pg_get_serial_sequence('permissoes', 'id'),(select max(id) from permissoes));
